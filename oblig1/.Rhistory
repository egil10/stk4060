setwd("C:/Users/ofurn/Dokumenter/Github/stk4060/oblig1")
clear
setwd("C:/Users/ofurn/Dokumenter/Github/stk4060/oblig1")
library(tidyverse)
set.seed(4060)
# exercise 1
# a)
rho <- 0.4
n   <- 100
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
acov_est <- acf(X, type = "covariance", plot = FALSE, lag.max = 3)$acf
tibble(
lag = 0:3,
empirical_autocov = as.numeric(acov_est)
)
# b)
rho <- 0.4
n   <- 100
beta <- 0.05
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
t <- 1:n
Y <- beta * t + X
# theoretical autocovariance of Y: since beta*t is deterministic,
# Cov(Yt, Ys) = Cov(Xt, Xs) = rho^|t-s|
# plot Y_t
df_Y <- tibble(
time = t,
Y = Y
)
p1 <- ggplot(df_Y, aes(time, Y)) +
geom_line() +
theme_bw() +
labs(title = "Simulated Y_t = beta*t + X_t")
ggsave("plots/Y_series.pdf", p1, width = 12, height = 6)
# empirical autocovariance
acov_Y <- acf(Y, type = "covariance", plot = FALSE, lag.max = 3)$acf
tibble(
lag = 0:3,
empirical_autocov_Y = as.numeric(acov_Y)
)
# c)
rho <- 0.4
n   <- 100
beta <- 0.05
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
t <- 1:n
mu <- beta * t
Y  <- mu + X
# empirical autocovariance of Y (lags 0–3)
acov_Y <- acf(Y, type = "covariance", plot = FALSE, lag.max = 3)$acf
# expected value of gamma_hat_Y(h) when Y_t = mu_t + X_t (X zero-mean, stationary):
# E[ gamma_hat_Y(h) ] ≈ mean_{t=1..n-h}[(mu_t - mean(mu)) (mu_{t+h} - mean(mu))] + rho^h
# for mu_t = beta*t, the first term is large and positive, dominating the estimate
mu_bar <- mean(mu)
det_term <- sapply(0:3, function(h) {
m1 <- mu[1:(n - h)] - mu_bar
m2 <- mu[(1 + h):n] - mu_bar
mean(m1 * m2)
})
theory_gammaX <- rho^(0:3)
expected_acov <- det_term + theory_gammaX
tibble(
lag = 0:3,
empirical_autocov_Y = as.numeric(acov_Y),
deterministic_component = det_term,
gamma_X_theory = theory_gammaX,
expected_gammahat_Y = expected_acov
)
# d)
rho <- 0.4
n   <- 100
beta <- 0.05
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
t <- 1:n
Y <- beta * t + X
# detrend: Y*_t = Y_t - beta*t
Y_star <- Y - beta * t
acov_Y_star <- acf(Y_star, type = "covariance", plot = FALSE, lag.max = 3)$acf
tibble(
lag = 0:3,
empirical_autocov_Ystar = as.numeric(acov_Y_star)
)
library(tidyverse)
set.seed(4060)
# exercise 2
# a)
phi <- 0.543
n   <- 100
burn <- 200
# simulate AR(1) with burn-in
W <- rnorm(n + burn)
X <- numeric(n + burn)
X[1] <- rnorm(1, sd = 1 / sqrt(1 - phi^2))
for (t in 2:(n + burn)) {
X[t] <- phi * X[t - 1] + W[t]
}
# remove burn-in to get stationary sample
X <- X[(burn + 1):(burn + n)]
df_X <- tibble(
time = 1:n,
X = X
)
p <- ggplot(df_X, aes(time, X)) +
geom_line() +
theme_bw() +
labs(title = "AR(1) with phi = 0.543 and sigma = 1")
ggsave("plots/ar1_phi543.pdf", p, width = 12, height = 6)
df_X
# b)
loglik <- function(phi, X) {
n <- length(X)
term1 <- 0.5 * log(1 - phi^2)
term2 <- -0.5 * (1 - phi^2) * X[1]^2
term3 <- -0.5 * sum((X[2:n] - phi * X[1:(n-1)])^2)
term1 + term2 + term3
}
score <- function(phi, X) {
n <- length(X)
part1 <- -phi / (1 - phi^2)
part2 <- X[1]^2 * phi
part3 <- sum((X[2:n] - phi * X[1:(n-1)]) * X[1:(n-1)])
part1 + part2 + part3
}
Jn <- function(phi, X) {
n <- length(X)
s2 <- sum(X[1:(n-1)]^2)
part1 <- -(1 + phi^2) / (1 - phi^2)^2
part2 <- -sum(X[1]^2)
part3 <- -s2
-(1/n) * (part1 + part2 + part3)
}
loglik(phi, X)
score(phi, X)
Jn(phi, X)
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?
format=csv&bom=include&apisrc=
nbi&startPeriod=2024-10-21&endPeriod=2025-10-17&locale=no"
eur <- read.csv(eur_link,sep=";",header=TRUE)
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?
format=csv&bom=include&apisrc=
nbi&startPeriod=2024-10-21&endPeriod=2025-10-17&locale=no"
eur <- read.csv(eur_link,sep=";",header=TRUE)
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?format=csv&bom=include&apisrc=nbi&startPeriod=2024-10-21&endPeriod=2025-10-17&locale=no"
eur <- read.csv(eur_link,sep=";",header=TRUE)
xx <- as.numeric(gsub(",",".",eur$OBS_VALUE))
n <- length(xx)
eur
eur %>% as_tibble()
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?format=csv&bom=include&apisrc=nbi&startPeriod=2024-10-21&endPeriod=2025-10-17&locale=no"
eur <- read.csv(eur_link,sep=";",header=TRUE)
xx <- as.numeric(gsub(",",".",eur$OBS_VALUE))
n <- length(xx)
eur %>% as_tibble()
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?format=csv&bom=include&apisrc=nbi&startPeriod=2024-10-21&endPeriod=2025-10-17&locale=no"
eur <- read.csv(eur_link,sep=";",header=TRUE)
xx <- as.numeric(gsub(",",".",eur$OBS_VALUE))
n <- length(xx)
eur %>% as_tibble()
library(tidyverse)
library(readr)
# exercise 4)
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?format=csv&bom=include&apisrc=nbi&startPeriod=2024-10-21&locale=no"
eur <- read_csv2(eur_link, locale = locale(decimal_mark=",")) %>% arrange(TIME_PERIOD)
xx <- eur %>% mutate(v = parse_number(OBS_VALUE, locale=locale(decimal_mark=","))) %>% pull(v)
library(tidyverse)
library(readr)
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?format=csv&bom=include&apisrc=nbi&startPeriod=2024-10-21&locale=no"
eur <- read_csv2(eur_link, locale = locale(decimal_mark=","), show_col_types = FALSE) %>% arrange(TIME_PERIOD)
xx <- eur %>% pull(OBS_VALUE)
n  <- length(xx)
# a)
df <- tibble(date=eur$TIME_PERIOD, x=xx)
ggplot(df,aes(date,x))+geom_line()+theme_bw()
ggsave("plots/a.pdf",width=10,height=4)
phi <- sum(xx[-n]*xx[-1])/sum(xx[-n]^2)
s2 <- mean((xx[-1]-phi*xx[-n])^2)
se <- sqrt(s2/sum(xx[-n]^2))
phi; phi+c(-1,1)*qnorm(.975)*se
# b)
set.seed(4060)
Tobs <- n*(phi-1)
sim <- function(M=4000,m=2000){
Z<-matrix(rnorm(M*m,0,1/sqrt(m)),M);B<-t(apply(Z,1,cumsum))
int<-rowMeans(B^2);T<-0.5*(rchisq(M,1)-1)/int;T}
Tsim <- sim()
mean(abs(Tsim)>=abs(Tobs))
# c)
dx <- diff(xx); s2dx <- var(dx)
simW <- rnorm(length(dx),sd=sqrt(s2dx))
tibble(date=df$date[-1],dx,simW) %>%
pivot_longer(-date) %>%
ggplot(aes(date,value,color=name))+geom_line()+theme_bw()
ggsave("plots/c.pdf",width=10,height=4)
# d) e)
ll <- function(p){
l0<-exp(p[1]);c<-exp(p[2]);k<-l0/c;r<-1/c
sum(-(k+.5)*log(1/c+.5*dx^2))+(-length(dx)/2)*log(2*pi)-length(dx)*(l0/c)*log(c)+
length(dx)*(lgamma(k+.5)-lgamma(k))}
o<-optim(c(0,log(.2)),function(p)-ll(p))
l0<-exp(o$par[1]);c<-exp(o$par[2]);k<-l0/c;r<-1/c
lam<-rgamma(length(dx),k,r);sdv<-1/sqrt(lam)
simdx<-rnorm(length(dx),sd=sdv)
tibble(date=df$date[-1],dx,simdx) %>%
pivot_longer(-date) %>%
ggplot(aes(date,value,color=name))+geom_line()+theme_bw()
ggsave("plots/e.pdf",width=10,height=4)
# f)
h<-60
rwf<-xx[(n-h):(n-1)]
pred_rw<-xx[(n-h):(n-1)]
pred_ar<-map_dbl((n-h+1):n,function(t) as.numeric(predict(arima(xx[1:(t-1)],c(0,1,1)),1)$pred))
act<-xx[(n-h+1):n]
sqrt(mean((act-pred_rw)^2)); sqrt(mean((act-pred_ar)^2))
library(tidyverse)
library(readr)
eur_link <- "https://data.norges-bank.no/api/data/EXR/B.EUR.NOK.SP?format=csv&bom=include&apisrc=nbi&startPeriod=2024-10-21&locale=no"
eur <- read_csv2(eur_link, locale = locale(decimal_mark=","), show_col_types = FALSE) %>% arrange(TIME_PERIOD)
xx <- eur %>% pull(OBS_VALUE)
n  <- length(xx)
# a)
df <- tibble(date=eur$TIME_PERIOD, x=xx)
ggplot(df,aes(date,x))+geom_line()+theme_bw()
ggsave("plots/a.pdf",width=10,height=4)
phi <- sum(xx[-n]*xx[-1])/sum(xx[-n]^2)
s2 <- mean((xx[-1]-phi*xx[-n])^2)
se <- sqrt(s2/sum(xx[-n]^2))
phi; phi+c(-1,1)*qnorm(.975)*se
# b)
set.seed(4060)
Tobs <- n*(phi-1)
sim <- function(M=4000,m=2000){
Z<-matrix(rnorm(M*m,0,1/sqrt(m)),M);B<-t(apply(Z,1,cumsum))
int<-rowMeans(B^2);T<-0.5*(rchisq(M,1)-1)/int;T}
Tsim <- sim()
mean(abs(Tsim)>=abs(Tobs))
# c)
dx <- diff(xx); s2dx <- var(dx)
simW <- rnorm(length(dx),sd=sqrt(s2dx))
tibble(date=df$date[-1],dx,simW) %>%
pivot_longer(-date) %>%
ggplot(aes(date,value,color=name))+geom_line()+theme_bw()
ggsave("plots/c.pdf",width=10,height=4)
# d) e)
ll <- function(p){
l0<-exp(p[1]);c<-exp(p[2]);k<-l0/c;r<-1/c
sum(-(k+.5)*log(1/c+.5*dx^2))+(-length(dx)/2)*log(2*pi)-length(dx)*(l0/c)*log(c)+
length(dx)*(lgamma(k+.5)-lgamma(k))}
o<-optim(c(0,log(.2)),function(p)-ll(p))
l0<-exp(o$par[1]);c<-exp(o$par[2]);k<-l0/c;r<-1/c
lam<-rgamma(length(dx),k,r);sdv<-1/sqrt(lam)
simdx<-rnorm(length(dx),sd=sdv)
tibble(date=df$date[-1],dx,simdx) %>%
pivot_longer(-date) %>%
ggplot(aes(date,value,color=name))+geom_line()+theme_bw()
ggsave("plots/e.pdf",width=10,height=4)
# f)
h<-60
rwf<-xx[(n-h):(n-1)]
pred_rw<-xx[(n-h):(n-1)]
pred_ar<-map_dbl((n-h+1):n,function(t) as.numeric(predict(arima(xx[1:(t-1)],c(0,1,1)),1)$pred))
act<-xx[(n-h+1):n]
sqrt(mean((act-pred_rw)^2)); sqrt(mean((act-pred_ar)^2))
library(tidyverse)
set.seed(4060)
# exercise 2
# a)
phi <- 0.543
n   <- 100
burn <- 200
# simulate AR(1) with burn-in
W <- rnorm(n + burn)
X <- numeric(n + burn)
X[1] <- rnorm(1, sd = 1 / sqrt(1 - phi^2))
for (t in 2:(n + burn)) {
X[t] <- phi * X[t - 1] + W[t]
}
# remove burn-in to get stationary sample
X <- X[(burn + 1):(burn + n)]
df_X <- tibble(
time = 1:n,
X = X
)
p <- ggplot(df_X, aes(time, X)) +
geom_line() +
theme_bw() +
labs(title = "AR(1) with phi = 0.543 and sigma = 1")
ggsave("plots/ar1_phi543.pdf", p, width = 12, height = 6)
df_X
# b)
loglik <- function(phi, X) {
n <- length(X)
term1 <- 0.5 * log(1 - phi^2)
term2 <- -0.5 * (1 - phi^2) * X[1]^2
term3 <- -0.5 * sum((X[2:n] - phi * X[1:(n-1)])^2)
term1 + term2 + term3
}
score <- function(phi, X) {
n <- length(X)
part1 <- -phi / (1 - phi^2)
part2 <- X[1]^2 * phi
part3 <- sum((X[2:n] - phi * X[1:(n-1)]) * X[1:(n-1)])
part1 + part2 + part3
}
Jn <- function(phi, X) {
n <- length(X)
s2 <- sum(X[1:(n-1)]^2)
part1 <- -(1 + phi^2) / (1 - phi^2)^2
part2 <- -sum(X[1]^2)
part3 <- -s2
-(1/n) * (part1 + part2 + part3)
}
loglik(phi, X)
score(phi, X)
Jn(phi, X)
library(tidyverse)
set.seed(4060)
# exercise 2
# a)
phi <- 0.543
n   <- 100
burn <- 200
W <- rnorm(n + burn)
X <- numeric(n + burn)
X[1] <- rnorm(1, sd = 1 / sqrt(1 - phi^2))
for (t in 2:(n + burn)) {
X[t] <- phi * X[t - 1] + W[t]
}
X <- X[(burn + 1):(burn + n)]
df_X <- tibble(
time = 1:n,
X = X
)
p <- ggplot(df_X, aes(time, X)) +
geom_line() +
theme_bw() +
labs(title = "AR(1) with phi = 0.543 and sigma = 1")
ggsave("plots/ar1_phi543.pdf", p, width = 12, height = 6)
df_X
# b)
loglik <- function(phi, X) {
n <- length(X)
term1 <- 0.5 * log(1 - phi^2)
term2 <- -0.5 * (1 - phi^2) * X[1]^2
term3 <- -0.5 * sum((X[2:n] - phi * X[1:(n-1)])^2)
term1 + term2 + term3
}
score <- function(phi, X) {
n <- length(X)
part1 <- -phi / (1 - phi^2)
part2 <- X[1]^2 * phi
part3 <- sum((X[2:n] - phi * X[1:(n-1)]) * X[1:(n-1)])
part1 + part2 + part3
}
Jn <- function(phi, X) {
n <- length(X)
s2 <- sum(X[1:(n-1)]^2)
part1 <- -(1 + phi^2) / (1 - phi^2)^2
part2 <- -sum(X[1]^2)
part3 <- -s2
-(1/n) * (part1 + part2 + part3)
}
loglik(phi, X)
score(phi, X)
Jn(phi, X)
# c)
meansq <- cumsum(X^2) / (1:n)
tail(meansq, 5)
# e)
f_ar1 <- function(w, phi) {
(1/(2*pi)) / (1 + phi^2 - 2*phi*cos(2*pi*w))
}
whittle <- function(phi, x){
n <- length(x)
j <- 1:floor((n-1)/2)
w <- j/n
dx <- fft(x) / sqrt(n)
Iw <- Mod(dx[j+1])^2
sum(log(f_ar1(w,phi)) + Iw / f_ar1(w,phi))
}
# f)
phis <- seq(-0.95, 0.95, by=0.01)
vals <- sapply(phis, whittle, x=X)
plot(phis, -vals, type="l")
ggsave("plots/whittle_curve.pdf", width=10, height=4)
# g)
sim_compare <- function(n, R=300, phi=0.543){
rmse <- function(est) sqrt(mean((est - phi)^2))
ml <- wh <- numeric(R)
for(r in 1:R){
W <- rnorm(n+200)
Z <- numeric(n+200)
Z[1] <- rnorm(1, sd = 1/sqrt(1-phi^2))
for(t in 2:(n+200)) Z[t] <- phi*Z[t-1]+W[t]
x <- Z[(200+1):(200+n)]
ml[r] <- optimize(function(a) -loglik(a, x), c(-0.99, 0.99))$minimum
wh[r] <- optimize(function(a) whittle(a, x), c(-0.99, 0.99))$minimum
}
c(RMSE_ML = rmse(ml), RMSE_Whittle = rmse(wh))
}
sim_compare(100)
sim_compare(500)
sim_compare(1000)
# h)
curv <- function(phi) {
j <- 1:floor((n-1)/2)
w <- j/n
sum( (phi - cos(2*pi*w))^2 * f_ar1(w,phi)^2 )
}
curv(phi)
library(tidyverse)
set.seed(4060)
# exercise 1
# a)
rho <- 0.4
n   <- 100
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
acov_est <- acf(X, type = "covariance", plot = FALSE, lag.max = 3)$acf
tibble(
lag = 0:3,
empirical_autocov = as.numeric(acov_est)
)
# b)
rho <- 0.4
n   <- 100
beta <- 0.05
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
t <- 1:n
Y <- beta * t + X
# theoretical autocovariance of Y: since beta*t is deterministic,
# Cov(Yt, Ys) = Cov(Xt, Xs) = rho^|t-s|
# plot Y_t
df_Y <- tibble(
time = t,
Y = Y
)
p1 <- ggplot(df_Y, aes(time, Y)) +
geom_line() +
theme_bw() +
labs(title = "Simulated Y_t = beta*t + X_t")
ggsave("plots/Y_series.pdf", p1, width = 12, height = 6)
# empirical autocovariance
acov_Y <- acf(Y, type = "covariance", plot = FALSE, lag.max = 3)$acf
tibble(
lag = 0:3,
empirical_autocov_Y = as.numeric(acov_Y)
)
# c)
rho <- 0.4
n   <- 100
beta <- 0.05
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
t <- 1:n
mu <- beta * t
Y  <- mu + X
# empirical autocovariance of Y (lags 0–3)
acov_Y <- acf(Y, type = "covariance", plot = FALSE, lag.max = 3)$acf
# expected value of gamma_hat_Y(h) when Y_t = mu_t + X_t (X zero-mean, stationary):
# E[ gamma_hat_Y(h) ] ≈ mean_{t=1..n-h}[(mu_t - mean(mu)) (mu_{t+h} - mean(mu))] + rho^h
# for mu_t = beta*t, the first term is large and positive, dominating the estimate
mu_bar <- mean(mu)
det_term <- sapply(0:3, function(h) {
m1 <- mu[1:(n - h)] - mu_bar
m2 <- mu[(1 + h):n] - mu_bar
mean(m1 * m2)
})
theory_gammaX <- rho^(0:3)
expected_acov <- det_term + theory_gammaX
tibble(
lag = 0:3,
empirical_autocov_Y = as.numeric(acov_Y),
deterministic_component = det_term,
gamma_X_theory = theory_gammaX,
expected_gammahat_Y = expected_acov
)
# d)
rho <- 0.4
n   <- 100
beta <- 0.05
Sigma <- outer(1:n, 1:n, function(t, s) rho^(abs(t - s)))
L <- chol(Sigma)
Z <- rnorm(n)
X <- as.vector(t(L) %*% Z)
t <- 1:n
Y <- beta * t + X
# detrend: Y*_t = Y_t - beta*t
Y_star <- Y - beta * t
acov_Y_star <- acf(Y_star, type = "covariance", plot = FALSE, lag.max = 3)$acf
tibble(
lag = 0:3,
empirical_autocov_Ystar = as.numeric(acov_Y_star)
)
